# f5-kvm-cloud-init

## ltm03.yaml
This is a yaml file that will be used as the 'user_data' in an ISO generated by the 'mk_cloud_init_iso.bash' script.
The ISO file will be mounted to the VM to provide cloud-init user-data to BIG-IP.
More information regarding the functions and capabilities of the cloud-init system on BIG-IP can be found
[here](https://github.com/F5Networks/f5-bigip-runtime-init) and [here](https://clouddocs.f5.com/cloud/public/v1/shared/cloudinit.html#tmos-declared-module-example).

## mk_cloud_init_iso.bash
This script creates the directory structure necessary for generation of the ISO file that provides the user-data to the BIG-IP VM.
The script takes the following actions:

1) Determines if the directory structure already exists
  * If the directory does not exist:
    * A static 'meta_data.json' file is used
    * The user-data file is created from the <vm>.yaml file, which should be located in the current directory
  * If the directory does exist the existing user-data file is overwritten with the <vm>.yaml file in the current directory
2) Ensure the current ISO file (if present) is not mounted via a loop device for inspection
  * If is is mounted, unmount it and delete the mount-point directory
3) Generate the ISO file
  * volume name: config-2
4) Copy the ISO file to /var/lib/libvirt/boot
5) If $cleanup == 1, delete the directory structure used to create the ISO.
6) If $MOUNT == 1, mount the ISO via loop device to the $mount_dir directory for inspection
7) Print the virt-install command required to create a new VM using this cloud-init


NOTE: The qcow2 for the VM must already exist for the 'virt-install' command to be successful. This script assumes that it is located at /var/lib/libvirt/f5, 
however that is easily changed by modifying the output of the 'cat' command. A future version will include a variable to specify the location of the QCOW2 that the VM 
should use.


To create a qcow2 that uses the default image as a backing disk use the following example (customzie for your environment):

qemu-img create -F qcow2 -b /var/lib/libvirt/images/BIGIP-15.1.5.1-0.0.14.qcow2 -f qcow2 /var/lib/libvirt/f5/ltm03.qcow2 100G
